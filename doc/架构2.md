系统工作流程：

​		用户首先需提供任务描述及目的（User Task），随后借助任务规划器（Task-planner）对任务进行规划。任务规划器利用大型语言模型（LLM）对任务进行深入理解，将其拆解为若干个可在单个无人机上独立执行的子任务（Subtask）（值得注意的是，子任务与无人机之间虽可能是多对多关系，但我们限定为单无人机执行单子任务或多子任务。若多无人机执行单子任务，多无人机间指令需同步，故在任务分解阶段，便将任务拆解为仅在单无人机上执行的子任务，以此规避相关问题。）。这些子任务应包含任务描述、优先级、依赖关系以及任务需求等关键要素。LLM进一步分析子任务，明确其由一个或多个步骤（Step）组成，并将这些步骤转化为一系列可执行的基本指令（Instruction）。

​		在任务规划阶段完成后，我们便获得了子任务集合以及与之对应的指令序列集合，随后便进入任务的分配调度执行阶段。

​		在此阶段，我们需先列出可用的无人机设备（device）以及无人机上可部署的软件能力库（model，也就是一些模型算法），添加到任务分配器（Task-Distributer）。子任务的执行依赖于无人机，因此首要任务是将子任务与无人机设备进行精准匹配。子任务具备任务描述和需求，无人机则拥有自身能力，借助LLM可判断无人机是否满足子任务需求，从而实现配对（需注意可能存在的死锁问题）。子任务与无人机成功配对后，还需依据子任务需求，在软件能力库中挑选合适的模型，模型根据实际情况和需求进行分割，部署到无人机、本地或者云端。若资源未能满足，所有任务则进入等待状态，放弃分配的资源，任务分配器重新分配资源，如果还是无法全部得到满足，则提示。最终，我们形成了由子任务、无人机和软件能力构成的子任务执行单元。

​		另外，系统初始化（Initializer）需要根据任务要求、无人机设备和软件能力情况在可选择的的无人机库和软件能力库和地图库中选择对应的文件，然后生成仿真环境的初始化启动文件。

​		接下来，我们通过任务调度执行器（Task-Executor）要对以子任务为单位（包含子任务、指令、无人机、软件能力）的执行集合进行调度与管理。首先需明确子任务的状态：待执行（READY），即任务已分配给无人机但尚未启动；执行中（RUNNING），任务正在运行，可能遭遇中断或暂停；已完成（COMPLETED），任务顺利结束；已中断（INTERRUPTED），因高优先级任务而被暂停；等待中（WAITING），因依赖或资源不足而未开始。

​		鉴于子任务优先级各异，任务调度执行器将满足资源要求的子任务纳入优先级队列，使其处于待执行状态，并依优先级顺序执行。同时，由于子任务间存在相互依赖，它们构成一个有向无环图。我们会优先挑选无依赖或依赖已满足的子任务执行，使其进入执行中状态。处于执行中状态的子任务，没有依赖的任务，可并行开展，因此可启动多个线程分别执行各子任务的指令。

​		每台无人机有一个无人机任务调度器（Drone-Scheduler）和无人机指令执行器（Drone-Executor），这个无人机任务调度器就是一个线程，其中每次只能有一个子任务，但是可能有其他依赖子任务是要在同一台无人机上执行的，并且指令也是连续不中断的，因此需要保证无人机任务调度器向无人机指令执行器发布指令。

​		对于每个执行中的子任务，其与无人机呈一对一关系，只需无人机指令执行器按指令队列顺序依次执行指令。

​		当子任务队列内指令执行完毕，该子任务便进入已完成状态，此时需将子任务的结果传递给对应依赖的子任务。其他子任务在每次有子任务完成后，会检查是否满足依赖关系要求。若依赖关系满足，则可进入执行中状态，开始指令执行。

​		此外，系统中还可能突发子任务，即要求中断其他子任务且优先级较高。当外部发布突发子任务时，任务调度执行器接收后会对比其优先级与当前子任务优先级，以及考量子任务的中断请求和是否清空请求。然后将其发布给无人机任务调度器，无人机任务调度器会根据需要发布中断指令给无人机指令执行器。若需中断，无人机指令执行器将暂停当前子任务，记录其指令执行情况，随即执行突发子任务。若要求清空，则直接清空子任务队列及所有待处理任务。若无清空要求，在突发子任务执行完毕后，恢复至中断时的状态。



**任务规划器（Task-Planner）：**

功能：

1. LLM需要理解用户的目标
2. LLM将用户的任务分解为单个无人机可执行的子任务，子任务应包含任务描述、优先级、依赖关系以及任务需求等信息
3. LLM再把每个子任务分解若干步骤，也就是无人机的一些可执行的动作，再根据提供的基本指令，最终每个子任务得到若干基本指令。

输入：用户的任务和目标

输出：子任务列表，每个子任务包含的指令



**任务分配器（Task-Distributer）：**

功能：

1. 存储每个用户任务包含的所有子任务、无人机库、软件能力库
2. 利用LLM将子任务与无人机库匹配，然后再和软件能力库匹配
3. 当有子任务执行结束或被终止时，释放资源，并重新尝试分配资源

输入：子任务列表，无人机库，软件能力库

输出：子任务、无人机、软件能力组合单元



**系统初始化（Initializer）：**

功能：

1. 在可选择的地图库中选择合适的地图
2. 根据无人机库和软件能力生成初始的无人机配置文件
3. 启动仿真环境

输入：用户的任务和目的，子任务、无人机和软件能力组合单元

输出：仿真地图文件、无人机配置文件、仿真启动文件



**任务执行器（Task-Executor）:**

功能：

1. 待执行的子任务（分配资源成功的子任务）加入优先级队列，对子任务优先级调度
2. 对子任务的状态进行监控，及时更改任务状态
3. 接收突发任务，如果有，判断是否需要中断
4. 接收任务的反馈，传输给所依赖的任务
5. 当有任务执行结束时，将所依赖的任务加入到优先级队列
6. 生成无人机执行线程

输入：子任务、外部任务

输出：



**无人机执行器**：

功能：

1. 保存子任务执行状态和无人机状态
2. 处理中断任务，暂停当前任务，中断后恢复原状态或清空任务
3. 按照指令队列依次执行执行（多个子任务可能是对于同一台无人机的连续指令，因此要保证无人机控制节点一直运行）

输入：任务队列

输出：无人机飞行，日志

TaskExecutor需要根据上一阶段得到的子任务字典，进行子任务的调度与执行。子任务已经分配好无人机和模型资源，不需要资源的再分配和回收，所有的子任务都可以加入到优先级队列中。由于子任务之间存在着依赖关系，也就是后续的子任务可能需要一些子任务为他提供数据，子任务是一个有向无环图的形式。因此需要先让没有依赖的任务执行，任务进入执行状态，任务执行结束后，状态进入结束，如果需要就把数据传给对应的子任务，然后将依赖这个任务的子任务继续执行。此外，多个正在执行的子任务之间可以并行执行，需要启动多个线程执行子任务，也就是DroneScheduler。TaskExecutor还需要接收外部发出的突发子任务，将子任务发布到对应无人机的DroneScheduler。TaskExecutor还需要接收到每个子任务的数据反馈，发布给对应的无人机。
DroneScheduler是对于无人机设备而言的，每台无人机可能执行多个子任务，这些子任务中包含指令，形成指令队列，子任务大概率是一个相关的连续的过程，因此指令需要保持连续。因为存在着子任务的依赖，所以每台无人机只有一个子任务在执行，正如前面所说，后续子任务也是这台无人机需要执行的，你需要解决这个问题，为DroneExecutor屏蔽子任务切换的发生，只向后提供一条条指令。在有突发子任务时，如果这个子任务需要中断且优先级高于当前的指令，则需要DroneExecutor中断，立即执行当前的指令。
DroneExecutor是对于无人机设备的执行器，它只专注于执行指令，根据指令的类型和参数，将指令发布出去。注意的是command_takeoff指令是启动无人机的指令，并且这个指令需要一直运行直到无人机降落，因为它需要接收其他指令，例如command_pos发来的位置指令进而控制无人机运动。另外，还存在中断指令，执行器还需要记录当前指令执行的位置，当出现中断指令时，执行器需要保存现场，然后立即执行中断指令的控制。中断指令执行结束后，根据它的要求，选择恢复到中断前的指令执行状态，或者清空所有的任务和指令。